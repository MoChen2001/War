# **War**

**unity 练手项目，类似《七日杀》的沙盒游戏。**

***Unity 版本 2017.1.0f3***

-----

***2021.07.28***

建造模块所有的物体的建造方式以及要注意的东西算是写完了，总的来说不是很复杂，不过确实很需要耐心调整一些细节，梯子和上楼的楼梯可以自己简单实现一下，并不是复杂，总的来说该模块也算是比较简单的，接下来还需要再处理一下该模块与枪械模块的以及冲突。

建造模块还有很多可以改进的地方，比如说透明建造物体实际上可以相办法不和角色发生碰撞等等（限制射线的最短长度应该可以做到）。

上楼的L型楼梯也可以进行优化，目前设置时很容易出现跳跃的情况，原因是设置位置的时候退出了触发，改一下触发器的大小啥的就可以解决该问题（实在是太懒了就没改）。

其他的很多地方的逻辑一可以进行优化，比如说，如果两个地基相隔一些距离放在一起，那么向上建造墙壁的时候，就会导致墙壁在两个地基之间跳跃，这个问题会导致你无法再控制透明墙壁（即墙壁一直在执行修改位置的逻辑），而且即使你远离或者看向其他地方，墙壁也不会执行其他代码而是依然跳跃，这个会形成一个死锁，只能通过取消透明墙壁的选中来解决，当然是在游戏内。游戏外的话，解决办法也不是很难，首先改变地基触发器的大小防止触发器重叠，然后再在代码中设置一个计数器就可以了（这个也是感觉行得通，因为太懒了所以也没做）。

差不多就这样，建造模块的Bug 相对来说不太多，更多的是触发器之间的各种奇怪的东西。

-----

***2021.07.15***

AI模块完成

感觉难度不大，很多细节都可以再次优化，比如说给敌人添加一个跟随血条啥的，有空的话明天做一下吧。

这一部分感觉自己发挥会更好，很多地方实际上原版的代码并不是很好（个人感觉）。

这一部分的屏幕血印实际上可以使用后处理的方式完成，事实上我也是这么做的，效果还是不错的。

总的来说这一部分并不是很难，自由发挥就好。

-----

***2021.07.12***

开始开发AI模块



----

***2021.7.10***

地形模块算是搞完了，地形实际上还是比较自由的，可以完全根据自己的喜好对地形进行设计，使用 Unity 内置的环境资源包基本上是够了。

需要注意的是地形中的障碍物的生成和处理，按照设计，地形中有三种类型的障碍物，石头、树木、矿石。

这三个都需要埋点之后进行生成，由于生成和处理的步骤基本相似，因此抽象出一个父类来进行处理，子类直接重写父类的方法就可以。有了之前枪械模块的学习，这里实际上写起来很简单。

需要注意的是，这些障碍物被攻击的时候要显示出特效，而特效的处理需要添加相应的脚本。同时更重要的是，按照之前的逻辑需要把这些障碍物的 layer 都设置为 Environment 才可以，就因为这个找了快一个小时才发现问题=-=，其他也没什么好说的。 



----

***2021.7.5***

有点忙就没太做这个，枪械模块的整合和一些细节算是写完了。

实际上没啥好说的，代码也没有特别复杂的地方，值得一提的是关于 UI 耐久值的更新，使用的是委托（上次项目得出的经验），效果还是不错的。

同时实现了一下武器合并时的耐久值更新，因为按照代码逻辑来说两把相同的武器是可以进行合并的，而合并之后应该更新一下耐久值，因此使用了几个变量，首先要获得单个武器的耐久值，其次是该 UI 中武器的数量，然后时当前的耐久值，如果出现了武器合并，就更新最大耐久值，然后在进行 UI 的耐久值更新就可以，这里再对 耐久值 UI 的颜色进行一次插值效果会更好。



其次是输入的管理器的配置，使用的是工厂模式，由于很多代码的实现都很鸡肋所以进行了一次大的更改，总的来说效果还是不错的。



还有一个算是比较有意思的问题，就是霞弹枪在射击之后立刻切换就会导致协程没有执行完毕，导致再次切换出来没法射击。解决方法是在初始化的动画中设置一个动画事件，每次切出来该类枪械的时候就将射击状态设置为可以射击。

这会导致霞弹枪切枪射击会比直接射击速度更快，不过这个好像也符合大多数 FPS 游戏的逻辑所以就不更改了。



总的来说，枪械模块还是蛮有意思的。

---

***2021.6.20***

四种枪械算是写完了，之间的关系也都架构了起来，到这里才终于体会到了面向对象思想的真正的实践是怎样的。

确实可以帮你节省很多的精力，也就是代码的冗余会大大的减少，不过构建的过程还是需要好好的思考一下的，因为其中的有的地方实际上是蛮有意思的的，就比如吧子类生命周期函数全部都抽先到父类之中，来避免子类之中产生一些生命周期函数，然后同时又给子类提供一些需要使用的虚方法作为一个接口，然后子类只需要对这个接口进行重写，就不需要使用生命周期函数，这些开放的接口都让子类去实现，父类只需要再对应的生命周期函数之中调用这些代码就可以实现目标。

还有就是关于字段和属性的重构，使用的方法是将共有的字段抽取出来，然后父类只需要对这些字段进行属性，同时如果是使用子类来实现这些字段而外部可能会使用这些属性，那么可以将属性的 get 方法写成 public ，而把 set 方法写成 protected ，来保证代码的封装性。

实际上对于方法也是这样的思路，比如说 view 层的方法，实际上大部分都是加载方法，所以应该是 protected 的访问权限，这这样就可以保证封装性。

这里倒是没有使用到接口，其实有的东西感觉是可以用接口来实现的，不过因为项目比较简单，所以不管是接口还是抽象父类实际上都没有太大的区别。



最后总结一下，一般的面向对象的构造的过程，首先是简单的完成其中的子类，如果有一些公共的部分就进行抽取，同时根据其中的作用对抽取的东西进行访问权限的管理。



----

***2021.6.9***

搞完了第一把枪械，现在来总结一下。

首先说角色控制，使用的是 Unity 自带的第一人称角色控制器（感觉实现的还行）。

然后设置了切换手上拿的物品的代码，实际上就是更换一下角色，同时使用动画衔接一下。



这里遇到的最大的麻烦大概就是双摄像机，首先来说一下双摄像机：

使用双摄像机的原因在于，角色显示想对于环境中的物品过于小，因此使用两个摄像机，一个角色摄像机，一个环境摄像机。

角色摄像机只观察角色，环境摄像机观察环境。同时调大角色摄像机的 FOV 值来让角色显得更大。

这样的好处是不会出现角色的穿模，而且达到了我们需要的效果。

坏处是如果贴近物体射击会出现一些问题。

同时还有一个问题，UI 应该使用哪个摄像机，最后决定用角色摄像机，因为如果用环境摄像机，会直接出现角色覆盖 UI 的现象。



然后是枪械模块的第一把枪械。

实际上完全可以直接让枪械模块产生 is-a  的继承关系，不过为了确定要抽象出哪些属性，所以先做出一个枪械来总结，后面会抽象出来的。

然后是**对象池**，为了避免多次产生和销毁对象产生的消耗，这里使用了对象池。

简单来说，就是让一些可能多次产生的对象在使用后不销毁而是存储引用之后隐藏，再次需要的时候在激活使用就可以。

内部使用队列是一个不错的选择。



关于对象池，如果同时产生了很多的对象，管理如此多的对象的消耗内存会不会适得其反，感觉还可以完善一下。

当对象池管理了很多的未使用对象的时候，缩减对象池。



---

***2021.5.26***

工具栏模块也搞完了，跟合成相比简单太多就不多说了。

这个模块加入的同时加入了常量类和输入管理器类以及隐藏 UI的接口，都比较简单不多说了。

值得一提的是常量类，这里由于工具栏有这 1~8 的常量按键控制，本来应该存为 **const** 数组，但由于 **const** 的局限性（**编译时常量**），这里使用 **static readonly（运行时常量）** 来作为一个类似的常量数组。然后再输入管理器类中直接使用循环遍历这个数组进行控制就可以了，不用再调用 8 次函数，减轻了负担，代码也看起来更舒服。



---

***2021.5.24***

总算是把合成模块搞完了，合成模块依旧是 MVC 模式。
合成模块总的来说要注意的细节比较多，该模块的 UI 大体上可以分为三大部分，左中右：




- **左部分：选项卡部分**

 单纯的选项卡，数据来源于 C 层， 同时选项卡的更换要有中间和右边部分的对应的数据的更新，这里使用的是物品的 ID 值来进行对应的更新。

 除此之外，每次更新选项卡的时候还要把中间和右边部分的槽中的物品重置回背包，首先将所有物品收集回一个字典（如果有重复就可以直接给重复物品叠加数目而不是往字典加数据），之后再调用背包控制脚本中的函数将这些物品放置回背包，这里会两次遍历背包。第一个找背包中每个物品的 ID 再字典中是否存在，如果存在，直接累加数目，从字典中移除。第一次循环结束后，如果字典还不为空，在遍历背包找空槽把字典中的数据填入就可以，虽然会比较麻烦，但总的来说可以最大程度保证背包的槽充分利用。这里还少一个就是如果背包的槽位置不够的处理，没写就等于直接丢弃，实际上应该直接扔出背包扔在地面上，这个以后来实现；

 这部分大概就这些稍微复杂一点的逻辑。

 

 

- **中部分，合成材料部分**

这里就主要是拖拽和拆分，如果材料足够，右边的合成按钮应该是可以使用的，所以需要一个计数变量来确定是否材料足够，这里直接使用存储槽中物体的 List 的数量进行计数。
值得一提的是，拖拽和拆分的时候要注意再不同地方调用代码来进行 List 中物体的移除和添加。
这里代码量比较大而且逻辑比较复杂，可以跟着注释多看几遍，理解不同情况下的处理方法和原因。





- **右部分，合成按钮和物品部分**

这里就比较简单了，合成材料的两个按钮绑定对应的事件。
事件向父层发送消息调用父层函数，父层函数先回调生成物体的方法，然后再对合成槽材料中的数量进行处理。


总的来说，合成模块最关键的还是拖拽和拆分，基本上每个功能都会涉及到这些，比如添加合成槽材料控制等等都要重构这里面的代码，十分重要。

---

***2021.5.14***

发烧给隔离了几天，继续回来搞。

现在搞的是合成模块。

合成模块的数据啥的部分和背包UI 基本类似，重点是拖拽和拆分的部分。

- 关于拖拽

  拖拽实际上是比较简单的，就是 UGUI 中的拖拽事件接口的重写，最难的大概就是拖拽结束时物体拖拽点的不同导致出的问题，注意这个就好了。

- 关于拆分

这里我把 UGUI 的Canvas 画布的模式调整为 Camera 模式保证可以射线检测到，然后书写拆分和合并代码就好了。
由于 UGUI 的拖拽使用鼠标的左右键都可以，所以进行拆分的时候要进行一个判断保证不是手误导致的拆分，这里左键拖拽、右键拆分。

---

***2021.4.29***

主要是对背包 UI 的一个实现。

用到了 MVC 模式，可以感觉到 MVC 模式的好处，并且可以用在很多之前没用到的地方来改善代码。

选项卡和 JSON 数据也是出现了多次的一个知识点，JSON几乎是必须掌握的就不再多说，选项卡的实现方式实际上是多样的，按个人喜好实现就好。

---

***2021.4.26***

终于准备开始这个大项目了，里面会涉及到很多之前学的知识，算是个大的总结和提升。顺便也感受一下大项目的设计和代码重构等等。

---



---

